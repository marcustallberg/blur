/*! Blur Fi - v0.1.0 - 2013-06-12
* https://github.com/marcus/blur_fi
* Copyright (c) 2013 Marcus Tallberg; Licensed MIT */
function Blur(t){this.pixelSize=t.pixelSize,this.uploadedImage=null,this.imageData=null,this.blurStyle=null,this.mouseBlur=!1,this.uiInited=!1,this.revertOnBlur=!0,this.pointRegister=[],this.updatePoint=!1,this.scaleImageToFit=!0,this.pixelCollection=[],this.dropZone=document.getElementById(t.dropAreaId),this.targetCanvas=document.getElementById("uploadedPic"),this.canvasSupport=null,this.fileReaderSupport=null,this.blurImageW=null,this.blurImageH=null,this.imgurlAPIkey="2b1e392999deaf5f7cac09a738aa3ae4",this.asciiCharMap=" .:-=+*#%@",this.asciiCharMapArr=this.asciiCharMap.split(""),this.asciiCharMapArr.reverse(),this.targetCanvas.getContext?(this.canvasSupport=!0,this.context=this.targetCanvas.getContext("2d"),this.init()):(this.canvasSupport=!1,document.getElementById("warningCanvas").style.display="block",this.dropZone.style.display="none"),window.File&&window.FileReader&&window.FileList&&window.Blob?this.fileReaderSupport=!0:(this.fileReaderSupport=!1,document.getElementById("warningFileApi").style.display="block",this.dropZone.style.display="none")}function setPlacement(){if($("footer").css({width:$("#settings").width()}),$(blurApp.targetCanvas).is(":hidden")){var t=$(window).height();t-=$("header").outerHeight()+10,t-=$("footer").height(),$("#main").height(t);var e=Math.floor(($(window).height()-$("header").outerHeight()-$("footer").height()-$("#dropArea").height())/2);$("#dropArea").addClass("active"),$("#dropArea").css({"padding-top":e+"px"})}else $("#main").css({height:""})}"bind"in Function.prototype||(Function.prototype.bind=function(t){var e=this,i=Array.prototype.slice.call(arguments,1);return function(){return e.apply(t,0===i.length?arguments:0===arguments.length?i:i.concat(Array.prototype.slice.call(arguments,0)))}}),Blur.prototype.init=function(){this.dropZone.addEventListener("dragover",this.onDragHandler,!1),this.dropZone.addEventListener("dragleave",this.onDragHandler,!1),this.dropZone.addEventListener("drop",this.onDrop.bind(this),!1)},Blur.prototype.initUI=function(){document.getElementById("saveToimgurl").addEventListener("click",this.uploadToimgurl.bind(this),!1),document.getElementById("saveImage").addEventListener("click",this.saveImage.bind(this),!1),document.getElementById("blurAll").addEventListener("click",this.blurAll.bind(this),!1),document.getElementById("revertImage").addEventListener("click",this.revertToOriginal.bind(this),!1),document.getElementById("reset").addEventListener("click",this.reset.bind(this),!1),document.getElementById("blurAll").style.display="block",document.getElementById("settings").style.display="block",this.uiInited=!0},Blur.prototype.reset=function(t){t.preventDefault(),this.context.clearRect(0,0,this.blurImageW,this.blurImageH),this.mouseBlur=!1,this.targetCanvas.style.display="none",document.getElementById("blurAll").style.display="none",document.getElementById("mouseBlur").checked=!1,document.getElementById("scaleImage").checked=!1,this.fileReaderSupport?this.dropZone.style.display="block":document.getElementById("uploadForm").style.display="block",setPlacement()},Blur.prototype.uploadToimgurl=function(t){t.preventDefault();var e,i=this;try{e=this.targetCanvas.toDataURL("image/jpeg",.9).split(",")[1]}catch(a){e=this.targetCanvas.toDataURL().split(",")[1]}var l=window.open();l.document.write("Uploading..."),$.ajax({url:"http://api.imgur.com/2/upload.json",type:"POST",data:{type:"base64",key:i.imgurlAPIkey,name:"blur.jpg",title:"Image created by http://www.blur.fi",caption:"Pixelate your images in your browser",image:e},dataType:"json"}).success(function(t){l.location.href=t.upload.links.imgur_page,$.ajax({url:"http://blur.fi/php/bridge.php?url=https://api.mongolab.com/api/1/databases/blur_fi_images/collections/gallery",data:JSON.stringify({data:t.upload}),type:"POST",contentType:"application/json",success:function(){}})}).error(function(){alert("Could not reach api.imgur.com. Sorry :("),l.close()})},Blur.prototype.setPixelSize=function(t){this.pixelSize=t,this.pointRegister=[]},Blur.prototype.setBlurStyle=function(t){this.blurStyle=t,this.pointRegister=[]},Blur.prototype.scaleToFit=function(t){this.scaleImageToFit=t,this.imgLoaded(this.uploadedImage)},Blur.prototype.blurWithMouse=function(t){this.mouseBlur=t,this.mouseBlur?this.targetCanvas.classList.add("mouseblur"):this.targetCanvas.classList.remove("mouseblur"),this.targetCanvas.addEventListener("mousedown",this.mousepresshandler.bind(this),!1),window.addEventListener("mouseup",this.mousepresshandler.bind(this),!1),this.targetCanvas.addEventListener("mousemove",this.mousemovehandler.bind(this),!1)},Blur.prototype.onDragHandler=function(t){t.preventDefault(),"dragover"===t.type?document.body.classList.add("active"):document.body.classList.remove("active")},Blur.prototype.onDrop=function(t){var e=this;t.preventDefault();for(var i=t.dataTransfer.files,a=0;i.length>a;a++){var l=new FileReader,s=i[a];l.onload=function(){return function(t){var i=new Image;i.onload=function(){e.imgLoaded(i)},i.src=t.target.result}}(s),l.readAsDataURL(s)}},Blur.prototype.revertToOriginal=function(t){t&&t.preventDefault(),this.context.clearRect(0,0,this.blurImageW,this.blurImageH),this.context.drawImage(this.uploadedImage,0,0,this.blurImageW,this.blurImageH)},Blur.prototype.mousepresshandler=function(t){t.preventDefault(),this.targetCanvas.style.cursor="mousedown"===t.type?"pointer":"default",this.updatePoint="mousedown"===t.type?!0:!1},Blur.prototype.mousemovehandler=function(t){this.updatePoint&&this.blurCoords(t.pageX,t.pageY),this.pixelCollection.length>0&&this.blurBlock(),this.updatePoint||0!==this.pixelCollection.length||this.targetCanvas.removeEventListener("mousemove",this.mousemovehandler.bind(this),!1)},Blur.prototype.imgLoaded=function(t){if(document.body.classList.remove("active"),this.dropZone.style.display="none",document.getElementById("uploadForm").style.display="none",this.uploadedImage=t,this.blurImageW=this.uploadedImage.width,this.blurImageH=this.uploadedImage.height,this.scaleImageToFit)if(this.blurImageW>window.innerWidth||this.blurImageH>window.innerHeight){var e=Math.min(window.innerWidth/this.blurImageW,window.innerHeight/this.blurImageH);this.blurImageW=e*this.blurImageW,this.blurImageH=e*this.blurImageH,document.getElementById("scaleImage").disabled=!1}else document.getElementById("scaleImage").disabled=!0;this.targetCanvas.style.width=this.targetCanvas.width=this.blurImageW,this.targetCanvas.style.height=this.targetCanvas.height=this.blurImageH,this.context.drawImage(t,0,0,this.blurImageW,this.blurImageH),this.targetCanvas.style.display="block",setPlacement(),this.uiInited?document.getElementById("blurAll").style.display="block":this.initUI()},Blur.prototype.saveImage=function(t){t.preventDefault();var e=this.context.canvas.toDataURL("image/png"),i=175,a=Math.floor(i*(this.targetCanvas.height/this.targetCanvas.width));$("#savedImage").html("<h5>RIGHT CLICK ON WINDOWS OR CTRL-CLICK ON MAC TO SAVE IMAGE. ON CHROME YOU CAN ALSO DRAG YOUR IMAGE TO YOUR DESKTOP</h5><br/><img width="+i+" height="+a+" title='Save image' draggable='true' src='"+e+"'/>"),$("#savedImage").slideDown(200)},Blur.prototype.blurAll=function(t){t.preventDefault(),this.revertOnBlur&&this.revertToOriginal();var e,i,a,l,s,r,n,o,h,c,u;h=this,i=new Date,c=h.pixelSize;var d=h.targetCanvas.height,g=h.targetCanvas.width,p={};p.w=p.h=c,e=4*h.pixelSize*h.pixelSize,null!==h.imageData?a=h.imageData:(l=h.context.getImageData(0,0,g,d),a=h.imageData=l.data);var m=g/c,x=d/c,b=[],y=null;for(n=0;m>n;n++)for(o=0;x>o;o++){p.h=Math.min(d-o*c,c);var v=0,f=0,S=0;for(s=0;p.h>s;s++)for(p.w=Math.min(g-n*c,c),r=0;p.w>r;r++)y=4*((c*o+s)*g+(c*n+r)),v+=a[y],f+=a[y+1],S+=a[y+2];e=4*p.h*p.w,b[b.length]={r:v,g:f,b:S,y:c*o,x:c*n,pixelW:p.w,pixelH:p.h,loopAmount:e}}this.drawPixels(b);var I=new Date;u=i.getTime();var C=I.getTime()-u;return"?debug"===location.search&&alert(C),_gaq.push(["_trackEvent","BlurRuntime",C+" ms"]),_gaq.push(["_trackEvent","BlurImageSize",g+"x"+d]),_gaq.push(["_trackEvent","BlurPixelSize",c+" px"]),_gaq.push(["_trackEvent","BlurPixelStyle","pixelStyle",this.blurStyle]),!1},Blur.prototype.drawPixels=function(t){this.blurFillOnePass(t)},Blur.prototype.setPixel=function(t,e,i,a,l,s,r){var n=4*(e+i*t.width);t.data[n+0]=a,t.data[n+1]=l,t.data[n+2]=s,t.data[n+3]=r},Blur.prototype.blurFillOnePass=function(t){var e=0,i=t.length;switch(this.blurStyle){case"ascii":this.context.fillStyle="rgba(255,255,255, 1)",this.context.fillRect(0,0,this.targetCanvas.width,this.targetCanvas.height),this.context.fillStyle="rgba(0,0,0,1)",this.context.font=this.pixelSize+"px Courier";break;case"crossStich":this.context.fillStyle="rgba(0,0,0,1)",this.context.fillRect(0,0,this.targetCanvas.width,this.targetCanvas.height);break;case"circular":this.context.fillStyle="rgba(20,20,20, 1)",this.context.fillRect(0,0,this.targetCanvas.width,this.targetCanvas.height);break;case"rastered":this.context.fillStyle="rgba(255,255,255, 1)",this.context.fillRect(0,0,this.targetCanvas.width,this.targetCanvas.height)}for(e=0;i>e;e++)this.blurFill(t[e],!0)},Blur.prototype.blurFill=function(t,e){var i,a=t.r,l=t.g,s=t.b,r=t.x,n=t.y,o=t.pixelW,h=t.pixelH,c=t.loopAmount,u=this.getRgbValue(a,l,s,c);switch(this.blurStyle){case"softblur":this.setPixel(this.collPixels,r/this.pixelSize,n/this.pixelSize,a,l,s,255);break;case"circular":e||(this.context.fillStyle="rgba(20,20,20, 1)",this.context.fillRect(r,n,o,h)),this.context.fillStyle="rgba("+u.r+", "+u.g+", "+u.b+", 0.7)",this.context.beginPath(),this.context.arc(r+this.pixelSize/2,n+this.pixelSize/2,this.pixelSize/2,0,2*Math.PI,!0),this.context.closePath(),this.context.fill();break;case"circularNegative":this.context.fillStyle="rgba("+Math.round(a/(c>>2))+", "+Math.round(l/(c>>2))+", "+Math.round(s/(c>>2))+", 1)",this.context.fillRect(r,n,o,h),this.context.fillStyle="rgba(20,20,20, 1)",this.context.beginPath(),this.context.arc(r+this.pixelSize/2,n+this.pixelSize/2,this.pixelSize/4,0,2*Math.PI,!0),this.context.closePath(),this.context.fill();break;case"invertedBackdrop":i=this.getRgbValue(a,l,s,c,!0),this.context.fillStyle="rgba("+u.r+", "+u.g+", "+u.b+", 1)",this.context.fillRect(r,n,o,h),this.context.fillStyle="rgba("+i.r+", "+i.g+", "+i.b+", 1)",this.context.beginPath(),this.context.arc(r+this.pixelSize/2,n+this.pixelSize/2,this.pixelSize/4,0,2*Math.PI,!0),this.context.closePath(),this.context.fill();break;case"invert":i=this.getRgbValue(a,l,s,c,!0),this.context.fillStyle="rgba("+i.r+", "+i.g+", "+i.b+", 1)",this.context.fillRect(r,n,o,h);break;case"desaturated":u=this.getRgbValue(a,l,s,c,!1,!0),this.context.fillStyle="rgba("+u.r+", "+u.g+", "+u.b+", 1)",this.context.fillRect(r,n,o,h);break;case"crossStich":e||(this.context.fillStyle="rgba(0,0,0, 1)",this.context.fillRect(r,n,o,h)),this.context.beginPath(),this.context.fillStyle="rgba("+u.r+", "+u.g+", "+u.b+", 1)",this.context.strokeStyle="rgba("+u.r+", "+u.g+", "+u.b+", 1)",this.context.lineWidth=Math.round(this.pixelSize/4),this.context.moveTo(r,n),this.context.lineTo(r+this.pixelSize,n+this.pixelSize),this.context.moveTo(r+this.pixelSize,n),this.context.lineTo(r,n+this.pixelSize),this.context.lineCap="square",this.context.stroke(),this.context.closePath();break;case"gradient":var d=Math.round(r+this.pixelSize/2),g=Math.round(n+this.pixelSize/2),p=this.pixelSize/5,m=d,x=g,b=this.pixelSize/1.3,y=this.context.createRadialGradient(d,g,p,m,x,b);y.addColorStop(0,"rgb("+Math.round(a/(c>>2))+","+Math.round(l/(c>>2))+", "+Math.round(s/(c>>2))+")"),y.addColorStop(.7,"rgb(0, 0, 0)"),this.context.fillStyle=y,this.context.fillRect(r,n,o,h);break;case"lineArt":this.context.fillStyle="rgba(0,0,0, 1)",this.context.fillRect(r,n,o,h),this.context.beginPath(),u=this.getRgbValue(a,l,s,c,!1,!1),this.context.fillStyle="rgba("+u.r+", "+u.g+", "+u.b+", 1)",this.context.strokeStyle="rgba("+u.r+", "+u.g+", "+u.b+", 1)",this.context.lineWidth=Math.round(this.pixelSize/4),this.context.moveTo(r+this.pixelSize,n),this.context.lineTo(r+this.pixelSize,n+this.pixelSize),this.context.lineCap="square",this.context.stroke(),this.context.closePath();break;case"desaturatedCircle":this.context.fillStyle="rgba(255,255,255, 1)",this.context.fillRect(r,n,o,h),u=this.getRgbValue(a,l,s,c,!1,!0),this.context.fillStyle="rgba("+u.r+", "+u.g+", "+u.b+", 1)",this.context.beginPath(),this.context.arc(r+this.pixelSize/2,n+this.pixelSize/2,this.pixelSize/2,0,2*Math.PI,!0),this.context.closePath(),this.context.fill();break;case"ascii":e||(this.context.fillStyle="rgba(255,255,255, 1)",this.context.fillRect(r,n,o,h),this.context.fillStyle="rgba(0,0,0,1)",this.context.font=this.pixelSize+"px Courier"),u=this.getRgbValue(a,l,s,c,!1,!0);var v=Math.max(0,Math.min(this.asciiCharMapArr.length,Math.floor((u.r-1)/(255/this.asciiCharMapArr.length))));this.context.fillText(this.asciiCharMapArr[v],r,n);break;case"bw":u=this.getRgbValue(a,l,s,c,!1,!0);var f=128>u.r?0:255;this.context.fillStyle="rgba("+f+", "+f+", "+f+", 1)",this.context.fillRect(r,n,o,h);break;case"rastered":e||(this.context.fillStyle="rgba(255,255,255, 1)",this.context.fillRect(r,n,o,h)),u=this.getRgbValue(a,l,s,c,!1,!0),this.context.fillStyle="rgba(0,0,0,1)",this.context.beginPath();var S=u.r/255;this.context.arc(r+this.pixelSize/2,n+this.pixelSize/2,Math.round(this.pixelSize/2-this.pixelSize/2*S),0,2*Math.PI,!0),this.context.closePath(),this.context.fill();break;default:this.context.fillStyle="rgba("+u.r+", "+u.g+", "+u.b+", 1)",this.context.fillRect(r,n,o,h)}},Blur.prototype.getRgbValue=function(t,e,i,a,l,s){var r={r:Math.round(t/(a>>2)),g:Math.round(e/(a>>2)),b:Math.round(i/(a>>2))};return l&&(r.r=Math.abs(r.r-255),r.g=Math.abs(r.g-255),r.b=Math.abs(r.b-255)),s&&(r.r=r.g=r.b=Math.round(.3*r.r+.59*r.g+.11*r.b)),r},Blur.prototype.blurBlock=function(){if(this.pixelCollection.length>0){var t,e,i,a,l,s=this.pixelCollection.shift(),r={};r.w=r.h=null,r.h=s.y+this.pixelSize<this.targetCanvas.height?this.pixelSize:this.targetCanvas.height-s.y,r.w=s.x+this.pixelSize<this.targetCanvas.width?this.pixelSize:this.targetCanvas.width-s.x;var n=4*r.w*r.h;if(0===n)return!1;l=this.context.getImageData(Math.min(s.x,this.targetCanvas.width),Math.min(s.y,this.targetCanvas.height),r.w,r.h),a=l.data,t=e=i=0;for(var o=0;n>o;)t+=a[o],i+=a[++o],e+=a[++o],o+=2;this.blurFill({r:t,g:i,b:e,y:s.y,x:s.x,pixelW:r.w,pixelH:r.h,loopAmount:n})}},Blur.prototype.blurCoords=function(t,e){if(this.mouseBlur){var i=this.snapCoord(t-this.targetCanvas.offsetLeft),a=this.snapCoord(e-this.targetCanvas.offsetTop);void 0===this.pointRegister[i+"x"+a]&&(this.pixelCollection.push({x:i,y:a}),this.pointRegister[i+"x"+a]=!0)}},Blur.prototype.snapCoord=function(t){var e=0;return e=this.pixelSize>t?0:Math.floor(t/this.pixelSize)*this.pixelSize};var blurApp=new Blur({pixelSize:15,dropAreaId:"dropArea"});$(".sizeSelector").click(function(t){t.preventDefault(),blurApp.setPixelSize($(t.currentTarget).data("pixel-size"))}),$(".styleSelector").click(function(t){t.preventDefault(),$(".styleSelector").removeClass("active"),$(t.currentTarget).addClass("active"),$("#displayBlurStyle").text("blurstyle: "+$(t.currentTarget).attr("title")),blurApp.setBlurStyle($(t.currentTarget).data("blur-style"))}),$(window).resize(function(){setPlacement()}),$(document).ready(function(){setPlacement()}),$("#mouseBlur, #scaleImage").change(function(t){t.preventDefault(),"mouseBlur"===$(t.currentTarget).attr("id")?blurApp.blurWithMouse($(t.currentTarget).is(":checked")):blurApp.scaleToFit($(t.currentTarget).is(":checked"))}),$("#slider").slider({max:50,min:3,value:10,step:1,slide:function(t,e){$("#displayPixelSize").text("Pixelsize: "+e.value)},stop:function(t,e){blurApp.setPixelSize(e.value)}}),$("#uploadForm a").click(function(t){t.preventDefault();var e=$("#uploadURL").val();$.getImageData({url:e,success:function(t){blurApp.imgLoaded(t)},error:function(){$("#uploadURL").val("Doh, something went wrong, try again later.")}})}),(navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPod/i)||navigator.userAgent.match(/iPad/i))&&$("#mouseBlur").hide();